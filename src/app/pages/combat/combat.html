<div class="combat-container">
  <div class="combat-header">
    <div class="header-content">
      <h1 class="combat-title">âš”ï¸ Active Combat</h1>
      <div class="combat-info" *ngIf="combatState()">
        <span class="round-counter">Round {{ combatState()!.round }}</span>
        <button class="btn btn-initiative" (click)="rollInitiative()">ğŸ² Roll Initiative</button>
        <button class="btn btn-danger" (click)="endCombat()">End Combat</button>
      </div>
    </div>
  </div>

  <div *ngIf="error()" class="error">{{ error() }}</div>
  <div *ngIf="loading()" class="loading">Initializing combat...</div>

  <div *ngIf="!loading() && combatState()" class="combat-layout">
    <!-- Initiative Tracker (Left Column) -->
    <div class="initiative-panel">
      <h2 class="panel-title">ğŸ“œ Initiative Order</h2>
      
      <div class="initiative-list">
        <div 
          *ngFor="let creature of sortedCreatures(); let i = index"
          class="initiative-item"
          [class.current-turn]="isCurrentTurn(creature.id)"
          [class.selected]="selectedCreatureId() === creature.id"
          (click)="selectCreature(creature.id)">
          
          <div class="turn-indicator" *ngIf="isCurrentTurn(creature.id)">
            <span class="indicator-arrow">â–¶</span>
          </div>

          <div class="creature-initiative-card">
            <div class="initiative-badge">{{ creature.initiative }}</div>
            
            <div class="creature-info">
              <h3 class="creature-name">{{ creature.name }}</h3>
              
              <div class="hp-display">
                <div class="hp-bar-container">
                  <div 
                    class="hp-bar" 
                    [style.width.%]="getHpPercentage(creature)"
                    [style.backgroundColor]="getHpColor(getHpPercentage(creature))">
                  </div>
                </div>
                <span class="hp-text">{{ creature.currentHp }}/{{ creature.maxHp }} HP</span>
              </div>

              <div class="creature-stats">
                <span class="stat-badge">AC {{ creature.armorClass }}</span>
                <span *ngFor="let effect of creature.statusEffects" 
                      class="status-badge"
                      (click)="removeStatusEffect(creature.id, effect); $event.stopPropagation()">
                  {{ effect }} âœ•
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="turn-controls">
        <button class="btn btn-primary btn-large" (click)="nextTurn()">
          Next Turn â–¶
        </button>
      </div>
    </div>

    <!-- Main Combat Area (Center) -->
    <div class="combat-main">
      <div *ngIf="selectedCreatureId()" class="creature-detail">
        <ng-container *ngFor="let creature of combatState()!.creatures">
          <div *ngIf="creature.id === selectedCreatureId()" class="detail-content">
            <div class="detail-header">
              <h2 class="detail-title">{{ creature.name }}</h2>
              <div class="detail-badges">
                <span class="badge-ac">ğŸ›¡ï¸ AC {{ creature.armorClass }}</span>
                <span class="badge-init">âš¡ Init {{ creature.initiative }}</span>
              </div>
            </div>

            <div class="hp-section">
              <h3 class="section-title">â¤ï¸ Hit Points</h3>
              <div class="hp-large-display">
                <div class="hp-value">{{ creature.currentHp }} / {{ creature.maxHp }}</div>
                <div class="hp-bar-large">
                  <div 
                    class="hp-fill" 
                    [style.width.%]="getHpPercentage(creature)"
                    [style.backgroundColor]="getHpColor(getHpPercentage(creature))">
                  </div>
                </div>
              </div>

              <div class="hp-controls">
                <div class="hp-control-group">
                  <label>Damage</label>
                  <div class="control-input-group">
                    <input 
                      type="number" 
                      [(ngModel)]="damageAmount" 
                      min="0" 
                      placeholder="0"
                      class="hp-input">
                    <button class="btn btn-damage" (click)="applyDamage(creature.id)">
                      ğŸ’¥ Apply
                    </button>
                  </div>
                </div>

                <div class="hp-control-group">
                  <label>Healing</label>
                  <div class="control-input-group">
                    <input 
                      type="number" 
                      [(ngModel)]="healAmount" 
                      min="0" 
                      placeholder="0"
                      class="hp-input">
                    <button class="btn btn-heal" (click)="applyHealing(creature.id)">
                      âœ¨ Heal
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="status-section">
              <h3 class="section-title">ğŸŒŸ Status Effects</h3>
              
              <div class="status-list">
                <div *ngFor="let effect of creature.statusEffects" class="status-item">
                  <span>{{ effect }}</span>
                  <button class="remove-status" (click)="removeStatusEffect(creature.id, effect)">
                    âœ•
                  </button>
                </div>
                <div *ngIf="creature.statusEffects.length === 0" class="no-status">
                  No status effects
                </div>
              </div>

              <div class="add-status">
                <input 
                  type="text" 
                  [(ngModel)]="newStatusEffect" 
                  placeholder="e.g., Poisoned, Stunned, Blessed"
                  class="status-input"
                  (keyup.enter)="addStatusEffect(creature.id)">
                <button class="btn btn-add-status" (click)="addStatusEffect(creature.id)">
                  + Add
                </button>
              </div>
            </div>

            <div class="initiative-section">
              <h3 class="section-title">âš¡ Initiative</h3>
              <div class="initiative-control">
                <input 
                  type="number" 
                  [(ngModel)]="initiativeValues()[creature.id]" 
                  class="initiative-input">
                <button class="btn btn-secondary" (click)="updateInitiative(creature.id)">
                  Update
                </button>
              </div>
            </div>

            <div class="attacks-section" *ngIf="creature.attacks && creature.attacks.length > 0">
              <h3 class="section-title">âš”ï¸ Attacks</h3>
              <div class="attacks-list">
                <div *ngFor="let attack of creature.attacks" class="attack-card">
                  <div class="attack-card-header">
                    <span class="attack-name">{{ attack.name }}</span>
                    <span *ngIf="attack.attackBonus" class="attack-bonus">+{{ attack.attackBonus }} to hit</span>
                    <button class="btn-roll-attack" (click)="rollAttack(attack, creature.name)" title="Roll Attack & Damage">
                      ğŸ²
                    </button>
                  </div>
                  <div class="attack-details">
                    <span *ngIf="attack.damage" class="attack-damage">
                      ğŸ’¥ {{ attack.damage }}
                      <span *ngIf="attack.damageType" class="damage-type">({{ attack.damageType }})</span>
                    </span>
                    <span *ngIf="attack.range" class="attack-range">ğŸ¯ {{ attack.range }}</span>
                  </div>
                  <div *ngIf="attack.description" class="attack-description">
                    {{ attack.description }}
                  </div>
                </div>
              </div>
            </div>

            <div class="defenses-section" *ngIf="(creature.resistances && creature.resistances.length > 0) || (creature.immunities && creature.immunities.length > 0) || (creature.weaknesses && creature.weaknesses.length > 0)">
              <h3 class="section-title">ğŸ›¡ï¸ Defenses</h3>
              <div class="defenses-grid">
                <div *ngIf="creature.resistances && creature.resistances.length > 0" class="defense-category">
                  <span class="defense-category-label">Resistances:</span>
                  <div class="defense-badges">
                    <span *ngFor="let resistance of creature.resistances" class="defense-badge resistance">{{ resistance }}</span>
                  </div>
                </div>
                <div *ngIf="creature.immunities && creature.immunities.length > 0" class="defense-category">
                  <span class="defense-category-label">Immunities:</span>
                  <div class="defense-badges">
                    <span *ngFor="let immunity of creature.immunities" class="defense-badge immunity">{{ immunity }}</span>
                  </div>
                </div>
                <div *ngIf="creature.weaknesses && creature.weaknesses.length > 0" class="defense-category">
                  <span class="defense-category-label">Weaknesses:</span>
                  <div class="defense-badges">
                    <span *ngFor="let weakness of creature.weaknesses" class="defense-badge weakness">{{ weakness }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="traits-section" *ngIf="creature.traits && creature.traits.length > 0">
              <h3 class="section-title">âœ¨ Special Traits</h3>
              <div class="traits-grid">
                <div *ngFor="let trait of creature.traits" class="trait-badge">{{ trait }}</div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <div *ngIf="!selectedCreatureId()" class="no-selection">
        <div class="no-selection-icon">ğŸ¯</div>
        <p>Select a creature from the initiative order to manage its status</p>
      </div>
    </div>

    <!-- Dice Roller (Right Column) -->
    <div class="tools-panel">
      <app-dice-roller />
    </div>
  </div>
</div>

<!-- Attack Roll Display -->
<app-attack-roll-display 
  [result]="attackRollResult()"
  [isOpen]="isAttackRollOpen()"
  (closeDisplay)="closeAttackRoll()">
</app-attack-roll-display>
